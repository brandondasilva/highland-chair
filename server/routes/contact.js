"use strict";function composeMail(a,b,c,d,e){var f=new helper.Content("text/html",d.message),g=new helper.Mail(a,b,c,f);return g.personalizations[0].addSubstitution(new helper.Substitution("-name-",d.name)),g.personalizations[0].addSubstitution(new helper.Substitution("-firstname-",d["first-name"])),g.personalizations[0].addSubstitution(new helper.Substitution("-mailinglist-",d["mailing-list"])),g.personalizations[0].addSubstitution(new helper.Substitution("-email-",d.email)),g.personalizations[0].addSubstitution(new helper.Substitution("-subject-",d.subject)),g.setTemplateId(e),sg.emptyRequest({method:"POST",path:"/v3/mail/send",body:g.toJSON()})}function sendgridRequest(a,b){sg.API(a,function(a,c){if(200==c.statusCode||202==c.statusCode||201==c.statusCode)if(void 0==b){var d={attachments:[{fallback:"SendGrid Email Request Successful!",color:"#1BDB6C",pretext:"SendGrid Email Request Successful!",title:"SendGrid Email Request Successful!",text:"The SendGrid request has been sent. Below is the response from SendGrid.",fields:[{title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}]}]};slackPost(d,process.env.SLACK_WEBHOOK_URL)}else b.attachments[0].fallback="SendGrid Contact Request Successful!",b.attachments[0].pretext="SendGrid Contact Request Successful!",b.attachments[0].title="SendGrid Contact Request Successful!",b.attachments[0].fields.push({title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}),slackPost(b,process.env.SLACK_WEBHOOK_URL);else{var e={attachments:[{fallback:"SENDGRID REQUEST FAILED",color:"#C10039",pretext:"SENDGRID REQUEST FAILED!",title:"SENDGRID REQUEST FAILED!",text:"The response from SendGrid is displayed below for more information.",fields:[{title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}]}]};void 0!=b&&(e.attachments[0].text+="\nThis request is for the SendGrid Contacts API"),slackPost(e,process.env.SLACK_WEBHOOK_URL)}console.log("--RESPONSE BEGIN--"),console.log(c.statusCode),console.log(c.body),console.log(c.headers),console.log("--RESPONSE END--\n")})}function sendgridContactRequest(a,b){sg.API(a,function(a,c){console.log("--RESPONSE BEGIN--"),console.log(c.statusCode),console.log(c.body),console.log(c.headers),console.log("--RESPONSE END--\n");var d="/v3/contactdb/lists/"+process.env.LIST_ID_MAILING+"/recipients/"+c.body.persisted_recipients[0],e=sg.emptyRequest({method:"POST",path:d});sendgridRequest(e,b)})}function slackPost(a){request({url:process.env.SLACK_WEBHOOK_URL,method:"POST",json:!0,body:a})}const clientName="Highland Chair Co.",clientEmail="sales@highlandchair.ca";var moment=require("moment-timezone"),express=require("express"),request=require("request"),router=express.Router(),helper=require("sendgrid").mail,sg=require("sendgrid")(process.env.SENDGRID_API_KEY);router.get("/",function(a,b){b.set("Access-Control-Allow-Origin","*"),b.send("API v1 GET: Hello World!")}),router.post("/",function(a,b){b.set("Access-Control-Allow-Origin","*"),a.body.name=a.body["first-name"]+" "+a.body["last-name"];var c=new helper.Email(clientEmail,clientName),d=new helper.Email(clientEmail,clientName),e=new helper.Email(a.body.email,a.body.name),f="New contact form submission on the "+clientName+" website!",g=clientName+" - Contact Form Submission Confirmation",h=composeMail(e,f,d,a.body,process.env.CONTACT_CLIENT_TEMPLATE),i=composeMail(c,g,e,a.body,process.env.CONTACT_USER_TEMPLATE),j={form:{attachments:[{fallback:"A new form on the "+clientName+" website has been submitted!",pretext:"A new form on the "+clientName+" website has been submitted!",title:"New Contact Form Submission",text:"A new form was submitted on the "+clientName+" website."}]},"mailing-list":{attachments:[{fallback:"A new contact has subscribed to the mailing list!",color:"#1BDB6C",pretext:"A new contact has subscribed to the mailing list!",title:"New Contact Added to the Mailing List",text:"New contact added to the mailing list."}]}};if("true"==a.body["mailing-list"]){var k=sg.emptyRequest({method:"POST",path:"/v3/contactdb/recipients",body:[{email:a.body.email,first_name:a.body["first-name"],last_name:a.body["last-name"]}]});sendgridContactRequest(k,j["mailing-list"])}sendgridRequest(h,void 0),sendgridRequest(i,void 0),slackPost(j.form,process.env.SLACK_WEBHOOK_URL),b.send(a.body)}),module.exports=router;